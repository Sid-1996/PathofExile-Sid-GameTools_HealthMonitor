# 🏗️ 技術架構說明

## 📖 這份文檔是給誰看的？

**這是技術文檔，主要供開發者和技術愛好者閱讀。**

如果你是普通用戶，只想使用工具的功能，請：
- 📥 [下載最新版本](../../../releases/latest)
- 📖 [查看使用說明](使用說明.md)

## 🎯 文檔目的

本文檔詳細說明了 PathofExile Sid GameTools_HealthMonitor 的技術實現，包括：
- 系統架構設計
- 核心算法原理
- 技術棧選擇
- 效能優化策略

## 💡 為什麼需要了解技術架構？

- **開發者**：了解系統設計，為二次開發做準備
- **技術愛好者**：學習遊戲輔助工具的實現技術
- **研究者**：了解電腦視覺在遊戲自動化中的應用

---

## 系統概觀

PathofExile Sid GameTools_HealthMonitor 採用模組化設計，確保高效能和可維護性。

## 📊 核心架構

```
┌─────────────────────────────────────────────────────────────┐
│                    主程式 (main.py)                          │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ GUI 界面模組 │  │ 監控核心模組 │  │ 配置管理模組 │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ 影像處理模組 │  │ 觸發執行模組 │  │ 系統整合模組 │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

## 🔧 技術棧

### 前端界面
- **Tkinter**: 原生 GUI 框架，輕量化界面設計
- **threading**: 多線程處理，確保界面響應性
- **PIL (Pillow)**: 圖像處理和顯示

### 影像處理
- **mss**: 高效能螢幕截圖，低延遲採樣
- **OpenCV**: 電腦視覺處理，HSV 色彩空間分析
- **NumPy**: 數值計算和陣列操作

### 系統整合
- **keyboard**: 全局熱鍵監聽
- **pygetwindow**: 視窗管理和定位
- **pyautogui**: 自動化操作執行

## 🎯 核心算法

### 1. 智能色彩檢測
```python
# HSV 色彩空間轉換
hsv_image = cv2.cvtColor(screenshot, cv2.COLOR_RGB2HSV)

# 動態閾值計算
health_mask = cv2.inRange(hsv_image, lower_red, upper_red)
mana_mask = cv2.inRange(hsv_image, lower_blue, upper_blue)

# 像素統計分析
health_percentage = calculate_bar_percentage(health_mask, region)
```

### 2. 實時監控循環
```python
def monitoring_loop():
    while monitoring_active:
        # 高效能截圖
        screenshot = capture_screen_region(monitor_area)
        
        # 並行處理
        health_data = analyze_health_bar(screenshot)
        mana_data = analyze_mana_bar(screenshot)
        
        # 觸發條件判斷
        check_trigger_conditions(health_data, mana_data)
        
        # 適應性延遲
        time.sleep(adaptive_delay)
```

### 3. 觸發機制
```python
def trigger_system():
    """
    智能觸發系統
    - 多重條件判斷
    - 冷卻時間管理
    - 優先級處理
    """
    if should_trigger_health():
        execute_health_action()
        
    if should_trigger_mana():
        execute_mana_action()
```

## 📁 檔案結構

```
src/
├── main.py                 # 主程式入口
├── gui_handler.py          # GUI 界面處理
├── monitor_core.py         # 監控核心邏輯
├── image_processor.py      # 影像處理模組
├── config_manager.py       # 配置文件管理
├── trigger_system.py       # 觸發執行系統
├── hotkey_manager.py       # 熱鍵管理
└── utils/
    ├── color_detector.py   # 顏色檢測工具
    ├── screen_capture.py   # 螢幕截圖工具
    └── system_tray.py      # 系統托盤集成
```

## ⚡ 性能優化

### 記憶體管理
- 智能截圖區域限制
- 圖像數據的及時釋放
- 配置緩存機制

### CPU 優化
- 多線程並行處理
- 適應性監控頻率
- 高效的像素統計算法

### 響應速度
- 硬體加速支援
- 預編譯正則表達式
- 最小化 I/O 操作

## 🛡️ 穩定性設計

### 例外處理
```python
try:
    screenshot = capture_screen()
    result = process_image(screenshot)
except ScreenCaptureError:
    fallback_capture_method()
except ProcessingError:
    reset_processing_state()
except Exception as e:
    log_error(e)
    continue_monitoring()
```

### 錯誤恢復
- 自動重試機制
- 降級處理策略
- 狀態一致性保證

## 🔗 擴展性

### 模組化設計
- 插件式架構支援
- 配置驅動功能
- API 接口預留

### 客製化支援
- 靈活的配置選項
- 用戶自定義規則
- 多遊戲適配潛力

---

**注意**: 此架構文檔僅展示技術設計概念，具體實現細節可能因版本更新而調整。